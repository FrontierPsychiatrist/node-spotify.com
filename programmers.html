<!DOCTYPE html><html><head><link rel="stylesheet" href="css/bootstrap.min.css" media="screen" type="text/css"><link rel="stylesheet" href="css/main.css" media="screen" type="text/css"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="Content-Type" content="text/html" charset="utf-8"><title>node-spotify: programmers</title><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/prettify.js"></script><link rel="stylesheet" href="css/prettify.css" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><div class="navbar"><div class="navbar-inner"><a href="index.html" class="brand">Home</a><ul class="nav"><li><a href="users.html">Users/Downloads</a></li><li class="active"><a href="programmers.html">Programmers</a></li><li><a href="api.html">node.js API</a></li><li><a href="impressum.html">Impressum</a></li></ul><a href="demo/index.html" class="btn btn-success pull-right">Try it!</a></div></div><div class="container"><h1>Programmers section</h1><p>This section is for people who want to dive in the code of the node-spotify module for node.js
It's written in C++ (c++011 standard). The following libraries/frameworks are used and not further explained in this guide:<ul><li><a href="http://nodejs.org/api/addons.html">node.js native module development</a>, <a href="https://code.google.com/p/v8/">google's V8</a></li></li><li><a href="http://nikhilm.github.com/uvbook/introduction.html">libuv event handling</a>, <a href="https://computing.llnl.gov/tutorials/pthreads/">pthreads</a></li></li><li><a href="https://developer.spotify.com/technologies/libspotify/docs/12.1.45/">libspotify</a></li></li></ul></p><p>The source code is available at
<a href="https://github.com/FrontierPsychiatrist/node-spotify" target="_blank">github</a></p><h2>Architecture</h2><p>In general, all complex operations are to be kept in the C++ code. The module should expose a simple as possible
API to node.js. This makes it easy to use for someone who does not have knowledge of libspotify. Also
it is easier to change, add or update libspotify calls when they are not just wrapped to JavaScript functions
but are kept together in small C++ methods/functions.</p><p>There are four types of objects to consider:<ul><li>Spotify objects. These objects wrap a libspotify type like playlist or track and expose methods like getTracks or
properties like "name". Most of them may only be constructed in the spotify thread.</li><li>NodeWrapped objects. <code>NodeWrapped</code> is a base class for objects that should be available in JavaScript.
It defines convenient methods to save callbacks and execute them. Most NodeWrapped objects save a delegate
spotify object and expose its methods to the user.</li><li><code>SpotifyService</code> is a singleton which starts and holds the Spotify thread. It must always be used
if a call to the Spotify library is to be executed.</li><li>Spotify Callbacks. Spotify allows the attachment to a variety of callbacks. The callback definitions for node-spotify
are available in the namespace <code>spotify</code>.</li></ul></p><h2>Threads</h2><p>There are two threads which concern a node-spotify developer.<ul><li>the node.js thread started when node.js loads</li><li>the Spotify thread</li></ul>These two threads need to communicate a lot. Both "want" to execute code concerning the other thread, but both aren't
threadsafe.</p><h3>Executing libspotify calls</h3><p>When starting a Spotify session, a new thread gets created that will run an endless loop which will be called the spotify
loop. The loop periodically needs to call <code>sp_session_process_events</code>. You can find this loop in the class
<code>SpotifyService</code></p><p>The JavaScript app for node.js needs to execute calls to the API of libspotify, e.g. to login or to get all playlists.
The developers of libspotify state that it isn't threadsafe and that <b>all</b> calls to it must come from the same thread
(the one running the main Spotify loop). This is done via C++11 lambdas.</p><script type="text/javascript">!function ($) {
    $(function(){
        window.prettyPrint && prettyPrint()
    })
}(window.jQuery)</script></div><footer class="footer"><div class="container"><p>node-spotify by FrontierPsychiatrist</p></div></footer></body></html>